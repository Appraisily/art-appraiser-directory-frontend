worker_processes  1;

events {
  worker_connections  1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile        on;
  keepalive_timeout  65;

  server {
    # Explicit favicon handling to avoid stale caches
    location = /favicon.ico {
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      return 301 /android-chrome-192x192.png?v=3;
    }

    location = /favicon.svg {
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      return 301 /android-chrome-192x192.png?v=3;
    }

    listen 8080;
    listen [::]:8080;
    server_name _;
    root /usr/share/nginx/html;

    index index.html;

    location = /health {
      default_type application/json;
      return 200 '{"status":"ok"}';
    }

    # Serve built assets directly; never rewrite to index.html
    location ^~ /assets/ {
      # If file doesn't exist, return 404 (do not fall back to index.html)
      try_files $uri =404;
      # Aggressive caching for hashed assets
      expires 1y;
      add_header Cache-Control "public, immutable, max-age=31536000";
      access_log off;
    }

    # Serve common static files directly
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|webp|woff|woff2|ttf|otf)$ {
      try_files $uri =404;
      expires 30d;
      add_header Cache-Control "public, max-age=2592000";
      access_log off;
    }

    # Do not cache HTML documents to avoid stale index.html pointing to old chunk names
    location ~* \.html$ {
      try_files $uri /index.html;
      add_header Cache-Control "no-cache, no-store, must-revalidate" always;
      add_header Cloudflare-CDN-Cache-Control "no-store" always;
      add_header cf-edge-cache "no-cache" always;
      add_header Pragma "no-cache" always;
      expires -1;
    }

    # SPA fallback for application routes
    location / {
      try_files $uri $uri/ /index.html;
      add_header Cache-Control "no-cache, no-store, must-revalidate" always;
      add_header Cloudflare-CDN-Cache-Control "no-store" always;
      add_header cf-edge-cache "no-cache" always;
      add_header Pragma "no-cache" always;
      expires -1;
    }

    # Redirect WordPress content to resources subdomain
    location ^~ /wp-content/ {
      return 301 https://resources.appraisily.com$request_uri;
    }

    # Redirect WordPress admin to resources subdomain
    location ^~ /wp-admin/ {
      return 301 https://resources.appraisily.com$request_uri;
    }

    # Canonicalize singular to plural: /appraisal/<id> â†’ https://appraisily.com/appraisals/<id>
    # Always emit the public HTTPS host to avoid leaking internal ports or schemes.
    location ~ ^/appraisal/([A-Za-z0-9-]+)/?$ {
      return 301 https://appraisily.com/appraisals/$1$is_args$args;
    }

    gzip on;
    gzip_types text/plain application/xml text/css text/javascript application/javascript application/json;
  }
}
